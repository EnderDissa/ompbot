# ompbot
![Static Badge](https://img.shields.io/badge/EnderDissa-ompbot-ompbot)
![GitHub top language](https://img.shields.io/github/languages/top/EnderDissa/ompbot)

VK-бот для предобработки и согласования служебных записок (СЗ) на проход гостей и внос/вынос оборудования от Офиса Молодёжных Проектов для Управления Физической Безопасности в ИТМО.

Что делает бот:
- принимает СЗ в ЛС сообщества (Excel `.xlsx` по шаблону или `.docx`),
- валидирует имя файла и (для `.xlsx`) содержимое по шаблону,
- сохраняет нормализованный файл в `data/` и пересылает его в менеджерский чат VK с кнопками,
- по кнопке **«АВТОСОГЛАСОВАНИЕ»** отправляет письмо с вложением на `pass@itmo.ru`,
- в фоне читает почту и ловит типовое подтверждение от `pass@itmo.ru` вида «Служебные записки согласованы…», после чего пишет в менеджерский чат, что СЗ согласована.

---

## Быстрый старт (Docker)

### 1) Подготовь окружение

Нужно:
- Docker Engine
- Compose v2 (`docker compose`)

Создай папку проекта и `compose.yml` рядом с репозиторием (или просто в папке репо):

```yaml
services:
  vk-bot:
    build: .
    image: ompbot:local
    container_name: vk-ompbot
    restart: unless-stopped
    environment:
      BOT_TOKEN: "<VK_GROUP_TOKEN>"
      MAIL_PASSWORD: "<MAILBOX_PASSWORD>"
      # ускоряет старт, если зависимости уже в образе:
      # SKIP_PIP_INSTALL: "1"
    volumes:
      - ./data:/app/data
```

> Если используешь не `build: .`, а `image: ...`, то изменения в коде на сервере сами по себе в контейнер **не попадут** — нужно собирать/обновлять образ.

### 2) Права на `data/`

Бот пишет файлы в `/app/data` (bind-mount `./data`). Папка `data` на хосте должна быть **доступна на запись** пользователю внутри контейнера.

Минимально:

```bash
mkdir -p data
chmod -R a+rwX data
```

(Если хочешь аккуратнее — выставь владельца/группу под UID контейнера.)

### 3) Запуск

```bash
docker compose up -d --build
```

Логи:

```bash
docker logs -f vk-ompbot
```

---

## Запуск без Docker

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt

export BOT_TOKEN='<VK_GROUP_TOKEN>'
export MAIL_PASSWORD='<MAILBOX_PASSWORD>'

python setup.py
python main.py
```

---

## Настройка

### Обязательные переменные окружения

- `BOT_TOKEN` — токен VK-сообщества (group token), которым бот слушает LongPoll и отправляет сообщения.
- `MAIL_PASSWORD` — пароль от ящика `omp@itmo.ru`, используемого для SMTP/IMAP (`smtp.mail.ru:465`, `imap.mail.ru:993`).

> `token.txt` в `setup.py` — легаси и сейчас не используется: в коде читается только `BOT_TOKEN`.

### Константы в коде, которые обычно правят при переносе

Файл `ompbot.py`:
- `admin_chat` — ID менеджерского чата **без** префикса `2000000000` (в коде используется `2000000000 + admin_chat`).
- `admins` — список VK ID админов (для админ-команд в ЛС).
- `groupid` — ID VK-сообщества (используется для ссылок и `groups.isMember`).

Файл `main.py`:
- `self.group_id` — ID VK-сообщества для LongPoll.

---

## Как бот работает в VK

### На что реагирует

1) **ЛС сообщества**: пользователь присылает документ (`.xlsx` или `.docx`).
2) Команда **«МЕНЕДЖЕР»** / **«АДМИН»** в ЛС — переключает режим вызова менеджера (бот временно перестаёт обрабатывать записки).

### Требования к имени файла

Имя должно начинаться с `СЗ_<ClubName>` и содержать точку после названия клуба, например:
- `СЗ_MyClub.xlsx`
- `СЗ_MyClub.метаинф.xlsx`

`<ClubName>`: буквы/цифры/`_`/`-` (без пробелов).

### Проверка `.xlsx`

Для Excel бот проверяет шаблон и данные (дата не в прошлом, номера/телефоны, базовые поля), после чего пересобирает файл в «чистом» виде и сохраняет в `data/xlsx/`.

Для `.docx` бот просто сохраняет копию в `data/docx/`.

### Привязка пользователя к клубу

Если пользователь впервые отправляет СЗ с новым `<ClubName>`, бот попросит подтвердить привязку. Она хранится в `data/users.yml`.

---

## Кнопки в менеджерском чате

После успешной обработки бот:
- отправляет пользователю сообщение «Принято…» и прикрепляет нормализованный документ,
- отправляет в менеджерский чат сообщение с документом и кнопками.

Кнопки:

- **АВТОСОГЛАСОВАНИЕ**
  - отправляет письмо на `pass@itmo.ru` с вложением,
  - пишет запись в `data/sent_docs.json` для последующего сопоставления ответа.

- **ОТПРАВИТЬ**
  - *не отправляет письмо*;
  - помечает в чате как «ОТПРАВЛЕНО» и уведомляет пользователя «принята и отправлена…».
  - удобно, если менеджер отправил СЗ вручную вне бота.

- **СОГЛАСОВАТЬ**
  - помечает как «СОГЛАСОВАНО» и уведомляет пользователя.

- **АННУЛИРОВАТЬ**
  - помечает как «АННУЛИРОВАНА» и уведомляет пользователя.

---

## Автоподтверждение по почте (как оно устроено)

Бот каждые ~30 секунд (см. `main.py`) читает IMAP ящик и пытается сопоставить ответы с отправленными СЗ.

Чтобы письмо считалось подтверждением, оно должно:
- прийти **от** `pass@itmo.ru`,
- содержать типовой текст вида: «Служебные записки согласованы и внесены в систему…» (матчится по ключевым словам),
- содержать в теме шестизначный идентификатор `(XXXXXX)`, который бот сам добавляет при отправке.

При совпадении бот пишет в менеджерский чат: `Служебная записка согласована: <filename>`.

Файлы состояния:
- `data/sent_docs.json` — что отправляли по кнопке «АВТОСОГЛАСОВАНИЕ»
- `data/received_docs.json` — какие письма уже считали
- `data/reconciliation_report.json` — отчёт по сопоставлению

---

## Как добавить/изменить менеджера (подпись в письме)

Подпись в письме для «АВТОСОГЛАСОВАНИЯ» выбирается по VK ID того, кто нажал кнопку.

Открой `utils/mail_helper.py` и заполни словарь:

```python
MANAGER_BY_VK_ID = {
    123456789: "Фамилия Имя Отчество",
    987654321: "Фамилия Имя Отчество",
}
```

Если VK ID не найден — используется `DEFAULT_MANAGER`.

---

## Траблшутинг

- `PermissionError: ... data/xlsx`
  - хостовая `./data` недоступна на запись контейнеру. Проверь права и владельца папки.

- `Permission denied` при `docker compose`
  - пользователь на сервере не имеет доступа к Docker сокету. Запускай через `sudo` или добавь пользователя в группу `docker`.

- Автоподтверждение не срабатывает
  - проверь `MAIL_PASSWORD` и доступ к IMAP;
